<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Matching Comparison Test (Debug)</title>
    <!-- Phase 1: Add mammoth.js library for DOCX file reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.13/mammoth.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f7f8fa 0%, #e4e7ec 100%);
            color: #1f2937;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #1f2937;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            color: #6b7280;
            font-size: 16px;
        }

        .debug-section {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .debug-section h3 {
            color: #92400e;
            margin-bottom: 8px;
        }

        .debug-info {
            font-family: monospace;
            background: #fbbf24;
            padding: 8px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 12px;
            color: #92400e;
        }

        .setup-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .setup-section h2 {
            color: #1f2937;
            font-size: 20px;
            margin-bottom: 16px;
        }

        .setup-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .setup-column {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .setup-column h3 {
            color: #374151;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }

        .input-group input[type="text"],
        .input-group input[type="password"],
        .input-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .input-group input[type="text"]:focus,
        .input-group input[type="password"]:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-group textarea {
            height: 120px;
            resize: vertical;
        }

        .button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .button:hover:not(:disabled) {
            background: #2563eb;
        }

        .button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .button-secondary {
            background: #6b7280;
        }

        .button-secondary:hover:not(:disabled) {
            background: #4b5563;
        }

        .button-success {
            background: #059669;
        }

        .button-success:hover:not(:disabled) {
            background: #047857;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 16px;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }

        .upload-area:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }

        .upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 48px;
            color: #9ca3af;
            margin-bottom: 16px;
        }

        .upload-text {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .upload-subtext {
            color: #9ca3af;
            font-size: 14px;
        }

        .uploaded-files {
            margin-top: 16px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-icon {
            font-size: 20px;
            color: #0284c7;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            color: #0c4a6e;
        }

        .file-size {
            font-size: 12px;
            color: #64748b;
        }

        .file-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .file-remove:hover {
            background: #dc2626;
        }

        .job-list {
            margin-top: 16px;
        }

        .job-item {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .job-title {
            font-weight: 600;
            color: #14532d;
        }

        .job-company {
            color: #15803d;
            font-size: 14px;
        }

        .job-description {
            color: #166534;
            font-size: 13px;
            margin-top: 8px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .job-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .job-remove:hover {
            background: #dc2626;
        }

        .status-bar {
            background: #1f2937;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 24px;
            display: none;
        }

        .status-bar.show {
            display: block;
        }

        .results-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .results-header h2 {
            color: #1f2937;
            font-size: 20px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-item {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }

        .result-column {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .result-column h3 {
            color: #374151;
            font-size: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .system-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-extension {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-webapp {
            background: #dcfce7;
            color: #166534;
        }

        .job-card {
            background: white;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .job-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-color: #3b82f6;
        }

        .job-card.expanded {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .job-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .job-card-title {
            font-weight: 600;
            color: #1f2937;
        }

        .job-card-company {
            color: #6b7280;
            font-size: 14px;
        }

        .match-score {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .score-badge {
            background: #3b82f6;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .score-badge.high {
            background: #059669;
        }

        .score-badge.medium {
            background: #d97706;
        }

        .score-badge.low {
            background: #dc2626;
        }

        .score-badge.excellent {
            background: #059669;
        }

        .score-badge.good {
            background: #10b981;
        }

        .score-badge.moderate {
            background: #f59e0b;
        }

        .score-badge.weak {
            background: #ef4444;
        }

        .score-badge.poor {
            background: #dc2626;
        }

        .score-badge.error {
            background: #6b7280;
        }

        .result-details {
            margin-top: 8px;
            padding: 8px;
            background: #f9fafb;
            border-radius: 4px;
            font-size: 12px;
            color: #6b7280;
        }

        .result-details div {
            margin: 2px 0;
        }

        .grade-badge {
            background: #f3f4f6;
            color: #374151;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .job-card-details {
            display: none;
            margin-top: 12px;
            border-top: 1px solid #e5e7eb;
            padding-top: 12px;
        }

        .job-card.expanded .job-card-details {
            display: block;
        }

        .resume-name {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .analysis-section {
            margin-bottom: 12px;
        }

        .analysis-section h4 {
            color: #374151;
            font-size: 14px;
            margin-bottom: 6px;
        }

        .analysis-list {
            list-style: none;
            margin-left: 0;
        }

        .analysis-list li {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 4px;
            padding-left: 16px;
            position: relative;
        }

        .analysis-list li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #3b82f6;
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #b91c1c;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
        }

        .processing-time {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 8px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #3b82f6;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .config-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .config-section h4 {
            color: #374151;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .config-option {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .config-option label {
            font-size: 14px;
            color: #4b5563;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Resume Matching Comparison Test (Debug Version)</h1>
            <p>Compare Extension 1.0 vs Extension 2.0 matching algorithms with weighted scoring</p>
            
            <div style="margin-top: 20px;">
                <button id="show-comparison-matrix" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    📊 Show Algorithm Comparison Matrix
                </button>
                <div id="comparison-matrix" style="display: none; margin-top: 16px; text-align: left; background: #f8fafc; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <h3 style="color: #3b82f6; margin-bottom: 8px;">🔍 Extension 1.0 Algorithm</h3>
                            <div style="font-size: 13px; color: #6b7280;">
                                <strong>Model:</strong> GPT-4o (More powerful)<br>
                                <strong>Approach:</strong> Holistic single-pass analysis<br>
                                <strong>Score Range:</strong> 0-100 (Harsh grading)<br>
                                <strong>Analysis Type:</strong> Interpretive matrix breakdown
                            </div>
                            <div style="margin-top: 8px; font-size: 12px;">
                                <strong>What it evaluates:</strong>
                                <ul style="margin-left: 16px; margin-top: 4px;">
                                    <li>Technical Skills vs Requirements</li>
                                    <li>Experience Level Match</li>
                                    <li>Education/Certification Alignment</li>
                                    <li>Industry/Domain Experience</li>
                                    <li>Seniority Level Match</li>
                                    <li>Overall Candidate-Job Fit</li>
                                </ul>
                            </div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <h3 style="color: #10b981; margin-bottom: 8px;">🔍 Extension 2.0 Algorithm</h3>
                            <div style="font-size: 13px; color: #6b7280;">
                                <strong>Model:</strong> GPT-4o (Same power)<br>
                                <strong>Approach:</strong> Weighted category scoring<br>
                                <strong>Score Range:</strong> 0-100 (Weighted system)<br>
                                <strong>Analysis Type:</strong> Category-based scoring with disqualification
                            </div>
                            <div style="margin-top: 8px; font-size: 12px;">
                                <strong>Category Weights:</strong>
                                <ul style="margin-left: 16px; margin-top: 4px;">
                                    <li>Core Requirements: 4x (Critical)</li>
                                    <li>Important Skills: 2.5x (High impact)</li>
                                    <li>Soft Skills: 1.5x (Medium impact)</li>
                                    <li>Preferred: 1x (Low impact)</li>
                                </ul>
                                <strong>Match Levels:</strong>
                                <ul style="margin-left: 16px; margin-top: 4px;">
                                    <li>Full Match: 10 points</li>
                                    <li>Partial Match: 5 points</li>
                                    <li>No Match: 0 points</li>
                                </ul>
                                <strong>Special Features:</strong>
                                <ul style="margin-left: 16px; margin-top: 4px;">
                                    <li>Auto-disqualification for missing Core requirements</li>
                                    <li>Adjusted grade thresholds</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: #dbeafe; border-radius: 6px;">
                        <h4 style="color: #1e40af; margin-bottom: 8px;">🎯 Key Differences</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px;">
                            <div>
                                <strong>Extension 1.0:</strong> Provides interpretive scoring with holistic assessment and reasoning
                            </div>
                            <div>
                                <strong>Extension 2.0:</strong> Adds weighted category scoring with automatic disqualification for missing Core requirements
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <h3>🐛 Debug Information</h3>
            <div class="debug-info" id="debug-info">
Loading debug information...
            </div>
        </div>

        <div class="setup-section">
            <h2>⚙️ Configuration</h2>
            <div class="setup-grid">
                <div class="setup-column">
                    <h3>🔑 API Configuration</h3>
                    <div class="input-group">
                        <label for="openai-api-key">OpenAI API Key</label>
                        <input type="password" id="openai-api-key" placeholder="sk-...">
                    </div>
                    
                    <div class="config-section">
                        <h4>🧪 Advanced Options</h4>
                        <div class="config-option">
                            <label class="toggle-switch">
                                <input type="checkbox" id="enhanced-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                            <label for="enhanced-toggle">Enhanced 22-Variable Analysis</label>
                        </div>
                        <input type="checkbox" id="use-enhanced-matching" style="display: none;">
                    </div>
                </div>

                <div class="setup-column">
                    <h3>📄 Resume Upload</h3>
                    <div class="upload-area" id="upload-area">
                        <div class="upload-icon">📁</div>
                        <div class="upload-text">Drag and drop resume files here</div>
                        <div class="upload-subtext">or click to browse (PDF, DOC, DOCX, TXT)</div>
                        <input type="file" id="resume-upload" multiple accept=".pdf,.doc,.docx,.txt">
                    </div>
                    <button class="button" id="load-sample-resumes-btn" style="margin-top: 12px;">
                        <span>📋</span> Load Sample Attorney Resumes
                    </button>
                    <div class="uploaded-files" id="uploaded-files"></div>
                </div>
            </div>
        </div>

        <div class="setup-section">
            <h2>💼 Job Descriptions</h2>
            <div class="setup-grid">
                <div class="setup-column">
                    <h3>➕ Add New Job</h3>
                    <div class="input-group">
                        <label for="job-title">Job Title</label>
                        <input type="text" id="job-title" placeholder="Software Engineer">
                    </div>
                    <div class="input-group">
                        <label for="job-company">Company</label>
                        <input type="text" id="job-company" placeholder="Tech Corp">
                    </div>
                    <div class="input-group">
                        <label for="job-description">Job Description</label>
                        <textarea id="job-description" placeholder="Paste full job description here..."></textarea>
                    </div>
                    <button class="button" id="add-job-btn">
                        <span>➕</span> Add Job Description
                    </button>
                </div>

                <div class="setup-column">
                    <h3>📋 Current Jobs</h3>
                    <div class="job-list" id="job-list"></div>
                </div>
            </div>
        </div>

        <div class="setup-section">
            <h2>🚀 Run Comparison</h2>
            <button class="button button-success" id="run-comparison-btn" disabled>
                <span>🚀</span> Run Comparison
            </button>
            <button class="button button-secondary" id="export-results-btn" disabled style="margin-left: 16px;">
                <span>📊</span> Export Results
            </button>
        </div>

        <div class="status-bar" id="status-bar">
            <span id="status-text">Processing...</span>
        </div>

        <div class="results-section" id="results-section">
            <div class="results-header">
                <h2>📊 Comparison Results</h2>
            </div>
            
            <div class="summary-stats" id="summary-stats">
                <!-- Summary statistics will be populated here -->
            </div>

            <div class="results-grid">
                <div class="result-column">
                    <h3>
                        <span class="system-badge badge-extension">Extension 1.0</span>
                        Holistic AI Analysis
                    </h3>
                    <div id="extension-results"></div>
                </div>
                
                <div class="result-column">
                    <h3>
                        <span class="system-badge badge-webapp">Extension 2.0</span>
                        Weighted Category Scoring
                    </h3>
                    <div id="webapp-results"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('🔧 Debug script starting...');
        
        // Global variables
        let uploadedResumes = [];
        let addedJobs = [];
        let comparisonResults = {};
        let isProcessing = false;

        // Pre-populated job descriptions for testing
        const defaultJobs = [
            {
                title: "Senior Corporate Attorney",
                company: "AmLaw 100 Firm",
                description: `We are seeking a Senior Corporate Attorney with 6+ years of experience to join our San Francisco office. The ideal candidate will have extensive experience in domestic and cross-border mergers and acquisitions (M&A), venture capital and private equity sponsored investments, and complex corporate finance transactions.

Key Responsibilities:
- Handle domestic and cross-border mergers and acquisitions (M&A)
- Advise on venture capital and private equity sponsored investments
- Manage secured transactions and complex corporate finance
- Provide guidance on emerging corporate governance issues
- Draft, review, and negotiate various corporate agreements
- Conduct legal research and analysis for complex transactions

Required Qualifications:
- JD from accredited law school with outstanding academic credentials
- 6+ years of corporate law experience at top-tier law firm
- Strong M&A and corporate finance background
- Experience with SEC reporting and compliance
- Excellent analytical, writing, and communication skills
- Ability to work in fast-paced, deadline-driven environment
- Bar admission in California (or ability to obtain)

Preferred Qualifications:
- Experience with international transactions
- Technology sector experience
- CPA or MBA preferred
- Mandarin or Spanish language skills a plus

Compensation: $390,000 - $450,000 + bonus + benefits`
            },
            {
                title: "Criminal Defense Attorney",
                company: "Metro Legal Defense Group",
                description: `Established criminal defense firm in New York seeking an experienced Criminal Defense Attorney to handle a diverse caseload of criminal matters. This position offers the opportunity to work on high-profile cases while making a meaningful impact on clients' lives.

Key Responsibilities:
- Represent clients in criminal proceedings from arraignment through trial
- Conduct client interviews and case investigations
- Negotiate plea agreements with prosecutors
- Prepare and present cases at trial
- Handle appeals and post-conviction matters
- Maintain detailed case files and documentation
- Collaborate with investigators, expert witnesses, and support staff

Required Qualifications:
- JD from accredited law school
- 3+ years of criminal defense experience
- Strong trial advocacy skills
- Experience with felony and misdemeanor cases
- Knowledge of criminal procedure and evidence rules
- Excellent oral and written communication skills
- NY State Bar admission required
- Clean disciplinary record

Preferred Qualifications:
- Experience with white-collar criminal defense
- Federal court experience
- Spanish language proficiency
- Previous prosecutor experience
- Knowledge of sentencing guidelines

Compensation: $85,000 - $120,000 + performance bonuses`
            },
            {
                title: "Personal Injury Attorney",
                company: "Westside Injury Law",
                description: `Growing personal injury law firm seeks an experienced Personal Injury Attorney to join our Los Angeles office. The successful candidate will manage a caseload of personal injury matters while working closely with our experienced team of attorneys and support staff.

Key Responsibilities:
- Handle personal injury cases from initial consultation through resolution
- Conduct client interviews and case evaluations
- Investigate accidents and gather evidence
- Negotiate settlements with insurance companies
- Prepare cases for trial and represent clients in court
- Draft legal documents including complaints, motions, and discovery requests
- Maintain regular communication with clients throughout case progression
- Collaborate with medical experts, accident reconstruction specialists, and investigators

Required Qualifications:
- JD from accredited law school
- 4+ years of personal injury litigation experience
- Strong negotiation and settlement skills
- Trial experience required
- Knowledge of California personal injury law
- Excellent written and verbal communication skills
- California State Bar admission in good standing
- Ability to handle large caseload efficiently

Preferred Qualifications:
- Experience with catastrophic injury cases
- Medical malpractice experience
- Bilingual (English/Spanish) preferred
- Previous insurance defense experience
- Experience with mass tort litigation

Compensation: $110,000 - $160,000 + contingency fee sharing`
            },
            {
                title: "Immigration Attorney",
                company: "Sunshine Immigration Services",
                description: `Boutique immigration law firm in Miami seeking a dedicated Immigration Attorney to join our growing practice. The ideal candidate will have experience with various immigration matters and a passion for helping clients navigate the complex immigration system.

Key Responsibilities:
- Handle diverse immigration matters including family-based petitions, employment-based applications, and deportation defense
- Prepare and file applications with USCIS, DOL, and immigration courts
- Represent clients in immigration court proceedings
- Conduct client consultations and case assessments
- Draft legal briefs, motions, and appellate documents
- Stay current on changing immigration laws and regulations
- Provide legal advice on compliance matters for corporate clients
- Mentor junior attorneys and paralegals

Required Qualifications:
- JD from accredited law school
- 3+ years of immigration law experience
- Experience with USCIS applications and procedures
- Immigration court experience preferred
- Strong research and writing skills
- Bilingual (English/Spanish) required
- Florida Bar admission (or ability to obtain)
- Compassionate approach to client service

Preferred Qualifications:
- Experience with business immigration matters
- Knowledge of asylum and refugee law
- Federal court experience
- Additional language skills (Portuguese, French, Haitian Creole)
- Experience with removal defense
- AILA membership

Compensation: $75,000 - $110,000 + benefits`
            },
            {
                title: "Family Law Attorney",
                company: "Chicago Family Legal Center",
                description: `Established family law practice seeks an experienced Family Law Attorney to join our Chicago office. The successful candidate will handle a variety of family law matters with sensitivity and professionalism while advocating zealously for our clients.

Key Responsibilities:
- Handle divorce, custody, and support matters
- Negotiate prenuptial and postnuptial agreements
- Represent clients in domestic violence proceedings
- Conduct depositions and court hearings
- Draft pleadings, motions, and settlement agreements
- Mediate family disputes when appropriate
- Collaborate with financial experts, custody evaluators, and therapists
- Maintain detailed case files and client communications

Required Qualifications:
- JD from accredited law school
- 5+ years of family law experience
- Strong courtroom advocacy skills
- Experience with complex financial matters in divorce
- Knowledge of Illinois family law statutes
- Excellent interpersonal and communication skills
- Illinois State Bar admission required
- Ability to handle emotionally charged situations with professionalism

Preferred Qualifications:
- Experience with high-net-worth divorce cases
- Collaborative law training
- Mediation certification
- Experience with international custody matters
- Knowledge of tax implications in family law
- Spanish language skills

Compensation: $95,000 - $140,000 + bonus potential`
            }
        ];

        // Sample attorney resumes for testing
        const sampleResumes = [
            {
                name: "John_Smith_Corporate_Attorney.txt",
                size: 3250,
                type: "text/plain",
                content: `JOHN SMITH
Senior Corporate Attorney
Email: john.smith@email.com | Phone: (555) 123-4567
San Francisco, CA

PROFESSIONAL SUMMARY
Experienced corporate attorney with 8+ years specializing in mergers & acquisitions, venture capital, and complex corporate finance transactions. Strong background in securities law, corporate governance, and cross-border transactions. Proven track record of successfully closing deals worth over $2 billion.

EXPERIENCE

Senior Associate, Corporate Law | Wilson, Sonsini & Associates | 2019-Present
- Lead counsel on 25+ M&A transactions ranging from $50M to $500M
- Advised technology startups through Series A-C funding rounds
- Managed SEC reporting and compliance for public companies
- Drafted and negotiated complex corporate agreements and joint ventures
- Collaborated with international teams on cross-border transactions

Corporate Attorney | Morrison & Foerster | 2016-2019
- Supported senior partners on large-scale M&A deals
- Conducted due diligence for private equity and venture capital transactions
- Prepared SEC filings and proxy statements
- Advised on corporate governance matters for Fortune 500 companies

EDUCATION
J.D., Harvard Law School | 2016 | Magna Cum Laude
- Harvard Law Review, Editor
- Moot Court Competition, Semi-finalist

B.A., Economics | Stanford University | 2013 | Summa Cum Laude
- Phi Beta Kappa

BAR ADMISSIONS
California State Bar | 2016
New York State Bar | 2017

SKILLS
- M&A and Corporate Finance
- Securities Law and SEC Compliance
- Venture Capital and Private Equity
- Corporate Governance
- Contract Negotiation
- Cross-border Transactions
- Mandarin Chinese (Conversational)

CERTIFICATIONS
- Certified Public Accountant (CPA) | 2014`
            },
            {
                name: "Sarah_Johnson_Criminal_Defense.txt",
                size: 2890,
                type: "text/plain",
                content: `SARAH JOHNSON
Criminal Defense Attorney
Email: sarah.johnson@email.com | Phone: (555) 987-6543
New York, NY

PROFESSIONAL SUMMARY
Dedicated criminal defense attorney with 5+ years of experience representing clients in state and federal courts. Skilled in trial advocacy, plea negotiations, and appellate work. Strong track record of achieving favorable outcomes for clients facing serious criminal charges.

EXPERIENCE

Criminal Defense Attorney | Johnson & Associates | 2020-Present
- Represent clients in felony and misdemeanor cases including DUI, drug offenses, and white-collar crimes
- Achieved 85% success rate in plea negotiations
- Conducted 15+ jury trials with 70% acquittal rate
- Handle post-conviction appeals and sentence modifications
- Collaborate with private investigators and expert witnesses

Assistant District Attorney | Manhattan District Attorney's Office | 2018-2020
- Prosecuted criminal cases from arraignment through trial
- Managed caseload of 150+ active cases
- Specialized in financial crimes and fraud cases
- Trained junior prosecutors on trial advocacy techniques
- Maintained 90% conviction rate

EDUCATION
J.D., New York University School of Law | 2018
- Criminal Law Journal, Staff Writer
- Legal Aid Society Clinic, Student Attorney

B.A., Political Science | Columbia University | 2015
- Dean's List all semesters

BAR ADMISSIONS
New York State Bar | 2018
U.S. District Court, Southern District of New York | 2019

SKILLS
- Trial Advocacy
- Criminal Procedure
- Evidence Law
- Plea Negotiations
- Appellate Brief Writing
- Client Counseling
- Spanish (Fluent)

NOTABLE CASES
- Successfully defended high-profile embezzlement case resulting in acquittal
- Achieved sentence reduction from 10 years to 3 years in federal drug case
- Won appeal overturning conviction for aggravated assault`
            },
            {
                name: "Michael_Davis_Personal_Injury.txt",
                size: 3120,
                type: "text/plain",
                content: `MICHAEL DAVIS
Personal Injury Attorney
Email: michael.davis@email.com | Phone: (555) 456-7890
Los Angeles, CA

PROFESSIONAL SUMMARY
Experienced personal injury attorney with 6+ years representing accident victims and their families. Skilled in negotiating with insurance companies and trying cases before juries. Recovered over $15 million in settlements and verdicts for clients.

EXPERIENCE

Senior Associate | Davis & Partners Personal Injury Law | 2019-Present
- Handle complex personal injury cases including auto accidents, medical malpractice, and premises liability
- Negotiated $2.5M settlement for catastrophic injury case
- Achieved $1.8M jury verdict in wrongful death case
- Manage caseload of 75+ active cases
- Mentor junior attorneys and paralegals

Personal Injury Attorney | Miller & Associates | 2018-2019
- Represented clients in motor vehicle accidents and slip-and-fall cases
- Conducted mediations and settlement conferences
- Prepared cases for trial and handled jury selection
- Collaborated with medical experts and accident reconstruction specialists

Insurance Defense Attorney | Pacific Insurance Legal | 2017-2018
- Defended insurance companies in personal injury claims
- Gained valuable insight into insurance company tactics and strategies
- Handled depositions and discovery matters

EDUCATION
J.D., UCLA School of Law | 2017
- Trial Advocacy Competition, Finalist
- Street Law Clinic, Student Attorney

B.A., Psychology | University of Southern California | 2014
- Psychology Honor Society

BAR ADMISSIONS
California State Bar | 2017

SKILLS
- Personal Injury Litigation
- Medical Malpractice
- Premises Liability
- Insurance Law
- Trial Advocacy
- Settlement Negotiations
- Spanish (Conversational)

NOTABLE SETTLEMENTS
- $2.5M - Catastrophic brain injury from auto accident
- $1.8M - Wrongful death verdict
- $950K - Medical malpractice settlement
- $750K - Premises liability case`
            }
        ];

        // Debug function to update debug info
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            const info = {
                timestamp: new Date().toLocaleTimeString(),
                uploadedResumes: uploadedResumes.length,
                addedJobs: addedJobs.length,
                isProcessing: isProcessing,
                apiKeySet: !!document.getElementById('openai-api-key').value.trim(),
                runButtonDisabled: document.getElementById('run-comparison-btn').disabled
            };
            debugInfo.textContent = JSON.stringify(info, null, 2);
        }

        // Simple resume upload setup
        function setupResumeUpload() {
            console.log('🔧 Setting up resume upload...');
            
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('resume-upload');
            const uploadedFilesDiv = document.getElementById('uploaded-files');

            // Click to upload
            uploadArea.addEventListener('click', () => {
                console.log('📁 Upload area clicked');
                fileInput.click();
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                console.log('📁 Files selected:', e.target.files.length);
                handleFiles(e.target.files);
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                console.log('📁 Files dropped:', e.dataTransfer.files.length);
                handleFiles(e.dataTransfer.files);
            });

            // Phase 1: DOCX file reading with mammoth.js
            async function readFileAsText(file) {
                console.log('📖 Reading file:', file.name, 'Type:', file.type);
                
                if (file.type === "text/plain" || file.name.endsWith('.txt')) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(new Error("File reading error: " + e.target.error));
                        reader.readAsText(file);
                    });
                } else if (file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document" || 
                           file.name.endsWith('.docx')) {
                    // This is a .docx file
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const arrayBuffer = e.target.result;
                            try {
                                // mammoth.js expects an ArrayBuffer
                                const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                                console.log('✅ DOCX text extracted successfully, length:', result.value.length);
                                resolve(result.value); // The extracted plain text
                            } catch (error) {
                                console.error("❌ Error extracting text from DOCX:", error);
                                reject(new Error("Failed to read DOCX file: " + error.message));
                            }
                        };
                        reader.onerror = (e) => reject(new Error("File reading error: " + e.target.error));
                        reader.readAsArrayBuffer(file); // Read as ArrayBuffer for mammoth.js
                    });
                } else {
                    throw new Error("Unsupported file type: " + file.type + " (filename: " + file.name + ")");
                }
            }

            function handleFiles(files) {
                console.log('📁 Processing files:', files.length);
                
                Array.from(files).forEach(async file => {
                    try {
                        const content = await readFileAsText(file);
                        const resume = {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            content: content
                        };
                        uploadedResumes.push(resume);
                        console.log('📄 Resume added:', resume.name, 'Content length:', content.length);
                        renderUploadedFiles();
                        updateRunButton();
                        updateDebugInfo();
                    } catch (error) {
                        console.error('❌ Error processing file:', file.name, error);
                        alert(`Error processing file ${file.name}: ${error.message}`);
                    }
                });
            }

            function renderUploadedFiles() {
                console.log('🔧 Rendering uploaded files...');
                uploadedFilesDiv.innerHTML = '';
                
                uploadedResumes.forEach((resume, index) => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file-item';
                    fileDiv.innerHTML = `
                        <div class="file-info">
                            <div class="file-icon">📄</div>
                            <div class="file-details">
                                <div class="file-name">${resume.name}</div>
                                <div class="file-size">${(resume.size / 1024).toFixed(1)} KB</div>
                            </div>
                        </div>
                        <button class="file-remove" onclick="removeResume(${index})">Remove</button>
                    `;
                    uploadedFilesDiv.appendChild(fileDiv);
                });
            }

            // Make removeResume globally accessible
            window.removeResume = function(index) {
                console.log('🗑️ Removing resume:', index);
                uploadedResumes.splice(index, 1);
                renderUploadedFiles();
                updateRunButton();
                updateDebugInfo();
            };

            // Load sample resumes function
            function loadSampleResumes() {
                console.log('📋 Loading sample attorney resumes...');
                uploadedResumes = [...sampleResumes];
                renderUploadedFiles();
                updateRunButton();
                updateDebugInfo();
            }

            // Make loadSampleResumes globally accessible
            window.loadSampleResumes = loadSampleResumes;
        }

        // Job handling setup
        function setupJobHandling() {
            console.log('🔧 Setting up job handling...');
            
            const addJobBtn = document.getElementById('add-job-btn');
            const jobListDiv = document.getElementById('job-list');

            addJobBtn.addEventListener('click', () => {
                console.log('💼 Add job button clicked');
                const title = document.getElementById('job-title').value.trim();
                const company = document.getElementById('job-company').value.trim();
                const description = document.getElementById('job-description').value.trim();

                if (title && company && description) {
                    const job = { title, company, description };
                    addedJobs.push(job);
                    console.log('💼 Job added:', job.title);
                    
                    // Clear form
                    document.getElementById('job-title').value = '';
                    document.getElementById('job-company').value = '';
                    document.getElementById('job-description').value = '';
                    
                    renderJobs();
                    updateRunButton();
                    updateDebugInfo();
                } else {
                    alert('Please fill in all job fields');
                }
            });

            function renderJobs() {
                console.log('🔧 Rendering jobs...');
                jobListDiv.innerHTML = '';
                
                addedJobs.forEach((job, index) => {
                    const jobDiv = document.createElement('div');
                    jobDiv.className = 'job-item';
                    jobDiv.innerHTML = `
                        <div class="job-header">
                            <div>
                                <div class="job-title">${job.title}</div>
                                <div class="job-company">${job.company}</div>
                            </div>
                            <button class="job-remove" onclick="removeJob(${index})">Remove</button>
                        </div>
                        <div class="job-description">${job.description.substring(0, 200)}...</div>
                    `;
                    jobListDiv.appendChild(jobDiv);
                });
            }
            
            // Make renderJobs globally accessible
            window.renderJobs = renderJobs;

            // Make removeJob globally accessible
            window.removeJob = function(index) {
                console.log('🗑️ Removing job:', index);
                addedJobs.splice(index, 1);
                renderJobs();
                updateRunButton();
                updateDebugInfo();
            };
        }

        // Extension matching logic (EXACT from popup.js)
        class ExtensionMatcher {
            constructor(apiKey) {
                this.apiKey = apiKey;
            }

            async calculateJobMatch(job, resume) {
                console.log(`🔍 Extension matcher processing: ${resume.name} vs ${job.title}`);
                const startTime = Date.now();
                
                try {
                    const truncatedResume = resume.content.length > 3000 ? 
                        resume.content.substring(0, 3000) + '...' : resume.content;
                    const truncatedJobDesc = job.description.length > 12000 ? 
                        job.description.substring(0, 12000) + '...' : job.description;

                    // EXACT PROMPT FROM ACTUAL EXTENSION (popup.js)
                    const matchPrompt = `
You are a strict ATS system that provides brutally honest job-resume matching scores. Be very discriminating and use the full 0-100 scale.

SCORING CRITERIA:
- 90-100: Perfect match - candidate exceeds ALL requirements
- 80-89: Excellent match - meets ALL requirements with some extras
- 70-79: Good match - meets MOST requirements with minor gaps
- 60-69: Moderate match - meets SOME requirements with notable gaps
- 50-59: Weak match - few requirements met, significant gaps
- 0-49: Poor match - fundamental misalignment, major gaps

JOB POSTING:
Title: ${job.title}
Company: ${job.company}
Description: ${truncatedJobDesc}

RESUME:
${truncatedResume}

ANALYSIS INSTRUCTIONS:
1. Count specific technical skills mentioned in job vs resume
2. Evaluate years of experience required vs actual
3. Check for education/certification requirements
4. Look for industry/domain experience alignment
5. Assess seniority level match

Be harsh but fair. Don't give sympathy scores. If there are major gaps, reflect this in a low score. Most candidates should score below 70 unless they're truly exceptional matches. Use the full range from 0-100.

CRITICAL: You MUST respond with ONLY valid JSON. Do not include any text before or after the JSON. Do not use markdown formatting like \`\`\`json. Just return the raw JSON object.

Format response as JSON with matrix structure:
{
  "overallScore": 45,
  "strengths": ["Specific matching skills/experience found"],
  "gaps": ["Specific missing requirements"],
  "recommendations": ["Concrete actionable advice"],
  "reasoning": "Detailed explanation of score calculation",
  "matrix": [
    {
      "category": "Technical Skills",
      "requirement": "Python programming, 5+ years",
      "evidence": "Python developer with 3 years experience",
      "matchLevel": "partial",
      "gapAction": "Highlight advanced Python projects to demonstrate deeper expertise"
    }
  ]
}
`;

                    console.log('🔍 Sending Extension request to OpenAI...');
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o',
                            messages: [
                                { role: 'system', content: matchPrompt }
                            ],
                            max_tokens: 1000,
                            temperature: 0.1
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`OpenAI API error: ${response.status}`);
                    }

                    const result = await response.json();
                    const content = result.choices[0].message.content;
                    console.log('✅ Extension response received');

                    // Parse JSON response
                    let cleanContent = content.replace(/^```json\s*/, '').replace(/\s*```$/, '');
                    cleanContent = cleanContent.replace(/^```\s*/, '').replace(/\s*```$/, '');
                    
                    const matchResult = JSON.parse(cleanContent);
                    
                    // Add processing time
                    matchResult.processingTime = Date.now() - startTime;
                    matchResult.matchGrade = this.getMatchGrade(matchResult.overallScore);
                    matchResult.system = 'extension';
                    
                    console.log(`✅ Extension match complete: ${matchResult.overallScore}% (${matchResult.matchGrade})`);
                    return matchResult;
                } catch (error) {
                    console.error('❌ Extension matching error:', error);
                    return {
                        overallScore: 0,
                        strengths: [],
                        gaps: ['Error processing match'],
                        recommendations: ['Please try again'],
                        reasoning: 'Processing error occurred',
                        matrix: [],
                        processingTime: Date.now() - startTime,
                        matchGrade: 'error',
                        system: 'extension',
                        error: error.message
                    };
                }
            }

            getMatchGrade(score) {
                if (score >= 85) return 'excellent';
                if (score >= 70) return 'good';
                if (score >= 55) return 'moderate';
                if (score >= 40) return 'weak';
                return 'poor';
            }
        }

        // Extension 2.0 matching logic with weighted category scoring
        class Extension2Matcher {
            constructor(apiKey) {
                this.apiKey = apiKey;
                // Extension 2.0 Category Weights and Match Level Points
                this.CATEGORY_WEIGHTS = {
                    "Core": 4,        // High impact: e.g., specific experience, mandatory certifications/licenses
                    "Important": 2.5,   // Medium-high impact: key responsibilities, significant skills
                    "Soft Skill": 1.5,  // Medium impact: general professional attributes
                    "Preferred": 1      // Low impact: nice-to-haves
                };
                
                this.MATCH_LEVEL_POINTS = {
                    "full": 10,
                    "meets": 10,        // Treat "meets" as full match
                    "exceeds": 10,      // Treat "exceeds" as full match
                    "partial": 5,
                    "none": 0,
                    "unverifiable": 2   // NEW: For items that can't be found but aren't necessarily a "none" match
                };
            }

            async performMatching(jobDescription, jobTitle, company, resumeText) {
                console.log(`🔍 Extension 2.0 matcher processing: ${jobTitle}`);
                const startTime = Date.now();
                
                try {
                    // Step 1: Smart truncation
                    const maxResumeLength = 3000; // ~750 tokens
                    const maxJobDescLength = 12000; // ~3000 tokens
                    
                    // Truncate resume preserving key sections
                    let truncatedResume = resumeText;
                    if (resumeText.length > maxResumeLength) {
                        const skillsMatch = resumeText.match(/(skills?|technologies?|expertise)[^]*?(?=\n\n|\n[A-Z]|$)/i);
                        const experienceMatch = resumeText.match(/(experience|employment|work)[^]*?(?=\n\n|\n[A-Z]|$)/i);
                        const educationMatch = resumeText.match(/(education|degree|university)[^]*?(?=\n\n|\n[A-Z]|$)/i);
                        
                        let keyContent = [skillsMatch?.[0], experienceMatch?.[0], educationMatch?.[0]]
                            .filter(Boolean).join('\n\n');
                        
                        if (keyContent.length > maxResumeLength) {
                            truncatedResume = keyContent.substring(0, maxResumeLength) + '...';
                        } else {
                            truncatedResume = keyContent || resumeText.substring(0, maxResumeLength) + '...';
                        }
                    }
                    
                    // Truncate job description preserving requirements
                    let truncatedJobDesc = jobDescription || '';
                    if (truncatedJobDesc.length > maxJobDescLength) {
                        const reqMatch = truncatedJobDesc.match(/(requirements?|qualifications?|must have|essential)[^]*?(?=\n\n|\n[A-Z]|$)/i);
                        const respMatch = truncatedJobDesc.match(/(responsibilities?|duties|role|what you'll do)[^]*?(?=\n\n|\n[A-Z]|$)/i);
                        
                        let keyContent = [reqMatch?.[0], respMatch?.[0]]
                            .filter(Boolean).join('\n\n');
                        
                        if (keyContent.length > maxJobDescLength) {
                            truncatedJobDesc = keyContent.substring(0, maxJobDescLength) + '...';
                        } else {
                            truncatedJobDesc = keyContent || truncatedJobDesc.substring(0, maxJobDescLength) + '...';
                        }
                    }
                    
                    // Step 2: Create the Extension 2.0 scoring prompt
                    const matchPrompt = `
You are a strict ATS system that provides brutally honest job-resume matching scores. Be very discriminating and use the full 0-100 scale.

SCORING CRITERIA:
- 90-100: Perfect match - candidate exceeds ALL requirements
- 80-89: Excellent match - meets ALL requirements with some extras
- 70-79: Good match - meets MOST requirements with minor gaps
- 60-69: Moderate match - meets SOME requirements with notable gaps
- 50-59: Weak match - few requirements met, significant gaps
- 0-49: Poor match - fundamental misalignment, major gaps

JOB POSTING:
Title: ${jobTitle}
Company: ${company}
Description: ${truncatedJobDesc}

RESUME:
${truncatedResume}

ANALYSIS INSTRUCTIONS:
1. Count specific technical skills mentioned in job vs resume
2. Evaluate years of experience required vs actual
3. Check for education/certification requirements
4. Look for industry/domain experience alignment
5. Assess seniority level match

CRITICAL: For each 'requirement' in the 'matrix', you MUST also provide a 'categoryType' field. Categorize each requirement as one of the following: "Core" (for absolute must-haves like specific certifications, mandatory experience years, or critical technical skills), "Important" (for key responsibilities or significant skills), "Soft Skill" (for general professional attributes), or "Preferred" (for desirable but not essential qualifications). This categorization is crucial as missing "Core" requirements will severely impact the final score.

IMPORTANT: For 'matchLevel', use "full", "partial", "none". If a requirement cannot be directly verified from the resume (e.g., "clean disciplinary record", "cultural fit", "ability to handle pressure"), use "unverifiable". Only use "none" when there's clear evidence the requirement is NOT met.

Be harsh but fair. Don't give sympathy scores. If there are major gaps, especially for 'Core' requirements, reflect this in a low score. Most candidates should score below 70 unless they're truly exceptional matches. Use the full range from 0-100.

CRITICAL: You MUST respond with ONLY valid JSON. Do not include any text before or after the JSON. Do not use markdown formatting like \`\`\`json. Just return the raw JSON object.

Format response as JSON with matrix structure:
{
  "overallScore": 45,
  "strengths": ["Specific matching skills/experience found"],
  "gaps": ["Specific missing requirements"],
  "recommendations": ["Concrete actionable advice"],
  "reasoning": "Detailed explanation of score calculation",
  "matrix": [
    {
      "category": "Technical Skills",
      "requirement": "Python programming, 5+ years",
      "evidence": "Python developer with 3 years experience",
      "matchLevel": "partial",
      "gapAction": "Highlight advanced Python projects to demonstrate deeper expertise",
      "categoryType": "Important"
    },
    {
      "category": "Certification",
      "requirement": "PMP Certification",
      "evidence": "No mention of PMP",
      "matchLevel": "none",
      "gapAction": "Obtain PMP certification",
      "categoryType": "Core"
    },
    {
      "category": "Professional Conduct",
      "requirement": "Clean disciplinary record",
      "evidence": "Not explicitly mentioned in resume",
      "matchLevel": "unverifiable",
      "gapAction": "None",
      "categoryType": "Core"
    }
  ]
}
`;

                    console.log('🔍 Sending Extension 2.0 request to OpenAI...');
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                    
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o',
                            messages: [
                                {
                                    role: 'system',
                                    content: 'You are a strict ATS system that provides brutally honest, discriminating job-resume match scores. Use the full 0-100 scale and be very analytical. Ensure each matrix item has a "categoryType" (Core, Important, Soft Skill, Preferred). Return only valid JSON.'
                                },
                                {
                                    role: 'user',
                                    content: matchPrompt
                                }
                            ],
                            max_tokens: 2500,
                            temperature: 0.1,
                            response_format: { "type": "json_object" } // PHASE 1: Force valid JSON output
                        }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const error = await response.json();
                        console.error('Extension 2.0 API Error Details:', error);
                        throw new Error(error.error?.message || `API Error: ${response.status} - ${response.statusText}`);
                    }

                    const result = await response.json();
                    const content = result.choices[0].message.content;
                    console.log('✅ Extension 2.0 response received');

                    // Phase 2: More aggressive JSON parsing with robust cleaning
                    let cleanContent = content.trim();
                    console.log('🔍 Raw LLM response length:', cleanContent.length);
                    
                    // Remove markdown code block fences if present
                    if (cleanContent.startsWith('```') && cleanContent.endsWith('```')) {
                        const firstNewline = cleanContent.indexOf('\n');
                        const lastNewline = cleanContent.lastIndexOf('\n');
                        if (firstNewline !== -1 && lastNewline !== -1 && firstNewline < lastNewline) {
                            cleanContent = cleanContent.substring(firstNewline + 1, lastNewline).trim();
                        }
                    }
                    
                    // Handle various markdown fence patterns
                    if (cleanContent.startsWith('```json')) {
                        cleanContent = cleanContent.replace(/```json\s*/, '').replace(/\s*```$/, '');
                    }
                    if (cleanContent.startsWith('```')) {
                        cleanContent = cleanContent.replace(/```\s*/, '').replace(/\s*```$/, '');
                    }
                    
                    // Find the first '{' and last '}' to isolate the JSON object
                    const firstBrace = cleanContent.indexOf('{');
                    const lastBrace = cleanContent.lastIndexOf('}');
                    if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                        cleanContent = cleanContent.substring(firstBrace, lastBrace + 1);
                    }
                    
                    console.log('🔍 Cleaned content length:', cleanContent.length);
                    console.log('🔍 First 100 chars:', cleanContent.substring(0, 100));
                    
                    let matchData;
                    try {
                        matchData = JSON.parse(cleanContent);
                        console.log('✅ JSON parsed successfully');
                    } catch (parseError) {
                        console.error('❌ JSON parsing failed:', parseError);
                        console.error('❌ Failed content:', cleanContent);
                        throw new Error(`JSON parsing failed: ${parseError.message}. Content: ${cleanContent.substring(0, 200)}...`);
                    }
                    
                    // Step 3: Implement weighted scoring and disqualification logic
                    let totalWeightedScore = 0;
                    let maxPossibleWeightedScore = 0;
                    let hasCriticalDisqualification = false;
                    
                    console.log('🔍 Extension 2.0 parsing matrix items:', matchData.matrix?.length || 0);

                    if (matchData.matrix && Array.isArray(matchData.matrix)) {
                        for (const item of matchData.matrix) {
                            const categoryType = item.categoryType || "Important"; // Default to Important if not provided by LLM
                            const matchLevel = item.matchLevel || "none"; // Default to none if not provided

                            const categoryWeight = this.CATEGORY_WEIGHTS[categoryType] || 1; // Default weight of 1
                            // Use explicit check for matchLevel points - handles "meets", "exceeds", "unverifiable"
                            const matchPoints = this.MATCH_LEVEL_POINTS[matchLevel] !== undefined ? 
                                this.MATCH_LEVEL_POINTS[matchLevel] : 0;

                            totalWeightedScore += matchPoints * categoryWeight;
                            maxPossibleWeightedScore += this.MATCH_LEVEL_POINTS['full'] * categoryWeight;

                            // Debug logging
                            console.log(`  - ${item.category}: ${categoryType} (${categoryWeight}x) ${matchLevel} (${matchPoints}pts) = ${matchPoints * categoryWeight}`);

                            // Only disqualify if a 'Core' requirement is explicitly 'none' (not 'unverifiable')
                            if (categoryType === "Core" && matchLevel === "none") {
                                hasCriticalDisqualification = true;
                                console.log(`  🚫 Critical disqualification: ${item.category} - ${item.requirement}`);
                            }
                        }
                    }

                    let finalOverallScore;
                    let finalMatchGrade;

                    console.log(`📊 Extension 2.0 scoring: ${totalWeightedScore}/${maxPossibleWeightedScore} = ${maxPossibleWeightedScore > 0 ? (totalWeightedScore / maxPossibleWeightedScore * 100).toFixed(1) : 0}%`);
                    console.log(`🚫 Critical disqualification: ${hasCriticalDisqualification}`);

                    if (hasCriticalDisqualification) {
                        finalOverallScore = 0; // Automatically disqualify with a very low score
                        finalMatchGrade = "disqualified"; // New match grade for clarity
                    } else if (maxPossibleWeightedScore > 0) {
                        finalOverallScore = (totalWeightedScore / maxPossibleWeightedScore) * 100;
                        finalOverallScore = Math.round(Math.max(0, Math.min(100, finalOverallScore))); // Ensure 0-100 range
                        
                        // Determine match grade based on new weighted score with adjusted thresholds
                        if (finalOverallScore >= 90) {
                            finalMatchGrade = "excellent";
                        } else if (finalOverallScore >= 75) { // Adjusted threshold for 'good'
                            finalMatchGrade = "good";
                        } else if (finalOverallScore >= 55) { // Adjusted threshold for 'moderate'
                            finalMatchGrade = "moderate";
                        } else if (finalOverallScore >= 30) { // Adjusted threshold for 'weak'
                            finalMatchGrade = "weak";
                        } else {
                            finalMatchGrade = "poor";
                        }
                    } else {
                        finalOverallScore = 0; // No requirements or issues parsing
                        finalMatchGrade = "poor";
                    }

                    const processedResult = {
                        overallScore: finalOverallScore,
                        strengths: matchData.strengths || [],
                        gaps: matchData.gaps || [],
                        recommendations: matchData.recommendations || [],
                        reasoning: matchData.reasoning || '',
                        matrix: matchData.matrix || [],
                        matchGrade: finalMatchGrade,
                        processingTime: Date.now() - startTime,
                        system: 'extension2',
                        analyzedAt: new Date().toISOString(),
                        // Add Extension 2.0 specific metadata
                        weightedScore: totalWeightedScore,
                        maxPossibleScore: maxPossibleWeightedScore,
                        hasCriticalDisqualification: hasCriticalDisqualification
                    };

                    console.log(`✅ Extension 2.0 match complete: ${finalOverallScore}% (${finalMatchGrade})`);
                    return processedResult;
                    
                } catch (error) {
                    console.error('❌ Extension 2.0 matching error:', error);
                    
                    // Handle different error types
                    if (error.name === 'AbortError') {
                        console.warn('Extension 2.0 match calculation timed out after 30 seconds');
                        throw new Error('Analysis timed out. Please try again.');
                    }
                    
                    return {
                        overallScore: 0,
                        strengths: [],
                        gaps: ['Error processing match'],
                        recommendations: ['Please try again'],
                        reasoning: 'Processing error occurred',
                        matrix: [],
                        processingTime: Date.now() - startTime,
                        matchGrade: 'error',
                        system: 'extension2',
                        error: error.message
                    };
                }
            }

            getMatchGrade(score) {
                if (score >= 90) return 'excellent';
                if (score >= 70) return 'good';
                if (score >= 50) return 'moderate';
                if (score >= 30) return 'weak';
                return 'poor';
            }
        }

        // REAL comparison function with actual matchers
        async function runComparison() {
            console.log('🚀 Starting REAL comparison with actual matchers...');
            
            if (isProcessing) {
                console.log('⚠️ Already processing, skipping...');
                return;
            }

            isProcessing = true;
            updateDebugInfo();

            const statusBar = document.getElementById('status-bar');
            const statusText = document.getElementById('status-text');
            const runBtn = document.getElementById('run-comparison-btn');

            try {
                statusBar.style.display = 'block';
                runBtn.disabled = true;
                updateRunButton();

                statusText.textContent = 'Validating inputs...';
                console.log('🔧 Validating inputs...');

                const apiKey = document.getElementById('openai-api-key').value.trim();
                if (!apiKey) {
                    throw new Error('OpenAI API key is required');
                }

                if (uploadedResumes.length === 0) {
                    throw new Error('No resumes uploaded');
                }

                if (addedJobs.length === 0) {
                    throw new Error('No jobs added');
                }

                console.log('✅ Validation complete');
                console.log(`📊 Processing ${uploadedResumes.length} resumes vs ${addedJobs.length} jobs`);

                // Initialize matchers
                const extensionMatcher = new ExtensionMatcher(apiKey);
                const extension2Matcher = new Extension2Matcher(apiKey);
                
                statusText.textContent = 'Initializing matching systems...';
                console.log('🔧 Matchers initialized');

                // Process each resume against each job
                const results = [];
                let testCount = 0;
                const totalTests = uploadedResumes.length * addedJobs.length;

                for (const resume of uploadedResumes) {
                    for (const job of addedJobs) {
                        testCount++;
                        statusText.textContent = `Processing test ${testCount}/${totalTests}: ${resume.name} vs ${job.title}`;
                        
                        console.log(`🔄 Processing test ${testCount}/${totalTests}: ${resume.name} vs ${job.title}`);
                        
                        // Run Extension matcher
                        console.log('🔍 Running Extension matcher...');
                        const extensionResult = await extensionMatcher.calculateJobMatch(job, resume);
                        
                        // Run Extension 2.0 matcher
                        console.log('🔍 Running Extension 2.0 matcher...');
                        const extension2Result = await extension2Matcher.performMatching(job.description, job.title, job.company, resume.content);
                        
                                                 // Create comparison result
                                                 const comparisonResult = {
                            resume: resume,
                            job: job,
                            extensionResult: extensionResult,
                            extension2Result: extension2Result,
                            timestamp: new Date().toISOString()
                        };
                        
                        results.push(comparisonResult);
                        console.log('✅ Test completed:', comparisonResult);
                    }
                }

                // Display results
                statusText.textContent = 'Displaying results...';
                console.log('📊 Displaying results...');

                const resultsSection = document.getElementById('results-section');
                const extensionResults = document.getElementById('extension-results');
                                const extension2Results = document.getElementById('webapp-results');
                
                extensionResults.innerHTML = '';
                extension2Results.innerHTML = '';

                results.forEach(result => {
                    // Extension results
                    const extCard = document.createElement('div');
                    extCard.className = 'job-card';
                    extCard.innerHTML = `
                        <div class="job-card-header">
                            <div>
                                <div class="job-card-title">${result.job.title}</div>
                                <div class="job-card-company">${result.job.company}</div>
                            </div>
                            <div class="match-score">
                                <div class="score-badge ${result.extensionResult.matchGrade}">${result.extensionResult.overallScore}%</div>
                            </div>
                        </div>
                        <div class="resume-name">Resume: ${result.resume.name}</div>
                        <div class="result-details">
                            <div>⚡ Processing: ${result.extensionResult.processingTime}ms</div>
                            <div>🎯 Grade: ${result.extensionResult.matchGrade}</div>
                            <div>💪 Strengths: ${result.extensionResult.strengths.length}</div>
                            <div>❌ Gaps: ${result.extensionResult.gaps.length}</div>
                        </div>
                        <div class="matrix-breakdown">
                            <button class="show-matrix-btn" onclick="toggleExtensionMatrix('ext-${result.resume.id}-${result.job.title.replace(/[^a-zA-Z0-9]/g, '')}')" style="margin-top: 8px; padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                📊 Show Matrix Breakdown
                            </button>
                            <div id="ext-${result.resume.id}-${result.job.title.replace(/[^a-zA-Z0-9]/g, '')}" class="matrix-content" style="display: none; margin-top: 8px; padding: 8px; background: #f8fafc; border-radius: 4px; font-size: 12px;">
                                ${formatExtensionMatrix(result.extensionResult)}
                            </div>
                        </div>
                    `;
                    extensionResults.appendChild(extCard);

                    // Extension 2.0 results
                    const ext2Card = document.createElement('div');
                    ext2Card.className = 'job-card';
                    ext2Card.innerHTML = `
                        <div class="job-card-header">
                            <div>
                                <div class="job-card-title">${result.job.title}</div>
                                <div class="job-card-company">${result.job.company}</div>
                            </div>
                            <div class="match-score">
                                <div class="score-badge ${result.extension2Result.matchGrade}">${result.extension2Result.overallScore || 0}%</div>
                            </div>
                        </div>
                        <div class="resume-name">Resume: ${result.resume.name}</div>
                        <div class="result-details">
                            <div>⚡ Processing: ${result.extension2Result.processingTime}ms</div>
                            <div>🎯 Grade: ${result.extension2Result.matchGrade}</div>
                            <div>💪 Strengths: ${result.extension2Result.strengths.length}</div>
                            <div>❌ Gaps: ${result.extension2Result.gaps.length}</div>
                            <div>🔗 Matrix Items: ${result.extension2Result.matrix ? result.extension2Result.matrix.length : 0}</div>
                            ${result.extension2Result.hasCriticalDisqualification ? '<div>🚫 Critical Disqualification</div>' : ''}
                            ${result.extension2Result.weightedScore ? '<div>📊 Weighted Score: ' + result.extension2Result.weightedScore + '/' + result.extension2Result.maxPossibleScore + '</div>' : ''}
                            ${result.extension2Result.error ? '<div>❌ Error: ' + result.extension2Result.error + '</div>' : ''}
                        </div>
                        <div class="matrix-breakdown">
                            <button class="show-matrix-btn" onclick="toggleExtension2Matrix('ext2-${result.resume.id}-${result.job.title.replace(/[^a-zA-Z0-9]/g, '')}')" style="margin-top: 8px; padding: 4px 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                📊 Show Weighted Matrix
                            </button>
                            <div id="ext2-${result.resume.id}-${result.job.title.replace(/[^a-zA-Z0-9]/g, '')}" class="matrix-content" style="display: none; margin-top: 8px; padding: 8px; background: #f8fafc; border-radius: 4px; font-size: 12px;">
                                ${formatExtension2Matrix(result.extension2Result)}
                            </div>
                        </div>
                    `;
                    extension2Results.appendChild(ext2Card);
                });

                resultsSection.style.display = 'block';
                comparisonResults = { results: results };

                statusText.textContent = 'Comparison completed successfully!';
                console.log('✅ Comparison completed successfully!');

                setTimeout(() => {
                    statusBar.style.display = 'none';
                }, 3000);

            } catch (error) {
                console.error('❌ Error during comparison:', error);
                statusText.textContent = `Error: ${error.message}`;
                setTimeout(() => {
                    statusBar.style.display = 'none';
                }, 5000);
            } finally {
                isProcessing = false;
                updateRunButton();
                updateDebugInfo();
            }
        }

        // Matrix breakdown formatting functions
        function formatExtensionMatrix(result) {
            if (!result || !result.matrix) {
                return '<div>No matrix data available</div>';
            }

            let html = '<div><strong>🔍 Extension Matrix Analysis:</strong></div>';
            html += '<div style="margin-top: 8px;">';
            
            // Overall summary
            html += `<div style="margin-bottom: 8px; padding: 6px; background: #e5e7eb; border-radius: 4px;">`;
            html += `<strong>Overall Score:</strong> ${result.overallScore}% (${result.matchGrade})<br>`;
            html += `<strong>Reasoning:</strong> ${result.reasoning || 'No reasoning provided'}`;
            html += '</div>';

            // Strengths
            if (result.strengths && result.strengths.length > 0) {
                html += '<div style="margin-bottom: 8px;"><strong>💪 Strengths:</strong><ul style="margin-left: 16px;">';
                result.strengths.forEach(strength => {
                    html += `<li style="color: #059669;">${strength}</li>`;
                });
                html += '</ul></div>';
            }

            // Gaps
            if (result.gaps && result.gaps.length > 0) {
                html += '<div style="margin-bottom: 8px;"><strong>❌ Gaps:</strong><ul style="margin-left: 16px;">';
                result.gaps.forEach(gap => {
                    html += `<li style="color: #dc2626;">${gap}</li>`;
                });
                html += '</ul></div>';
            }

            // Matrix breakdown
            if (result.matrix && result.matrix.length > 0) {
                html += '<div><strong>📊 Detailed Matrix:</strong></div>';
                html += '<div style="margin-top: 8px;">';
                
                result.matrix.forEach(item => {
                    const matchColor = item.matchLevel === 'strong' ? '#059669' : 
                                     item.matchLevel === 'partial' ? '#f59e0b' : 
                                     item.matchLevel === 'weak' ? '#ef4444' : '#6b7280';
                    
                    html += `<div style="margin-bottom: 8px; padding: 6px; border-left: 3px solid ${matchColor}; background: #f9fafb;">`;
                    html += `<strong>${item.category}:</strong><br>`;
                    html += `<span style="color: #6b7280; font-size: 11px;">Required:</span> ${item.requirement}<br>`;
                    html += `<span style="color: #6b7280; font-size: 11px;">Evidence:</span> ${item.evidence}<br>`;
                    html += `<span style="color: ${matchColor}; font-weight: bold;">Match:</span> ${item.matchLevel}<br>`;
                    if (item.gapAction) {
                        html += `<span style="color: #3b82f6; font-size: 11px;">Action:</span> ${item.gapAction}`;
                    }
                    html += '</div>';
                });
                html += '</div>';
            }

            // Recommendations
            if (result.recommendations && result.recommendations.length > 0) {
                html += '<div style="margin-top: 8px;"><strong>💡 Recommendations:</strong><ul style="margin-left: 16px;">';
                result.recommendations.forEach(rec => {
                    html += `<li style="color: #3b82f6;">${rec}</li>`;
                });
                html += '</ul></div>';
            }

            html += '</div>';
            return html;
        }

        function formatWebAppMatrix(result) {
            if (!result || !result.variables) {
                return '<div>No variable data available</div>';
            }

            let html = '<div><strong>🔍 Web App Variable Analysis:</strong></div>';
            html += '<div style="margin-top: 8px;">';
            
            // Overall summary
            html += `<div style="margin-bottom: 8px; padding: 6px; background: #e5e7eb; border-radius: 4px;">`;
            html += `<strong>Overall Score:</strong> ${result.overall_weighted_score || 0}% (${result.matchGrade})<br>`;
            html += `<strong>Status:</strong> ${result.status || 'unknown'}<br>`;
            html += `<strong>Variables Analyzed:</strong> ${result.variables ? result.variables.length : 0}`;
            html += '</div>';

            // Global weights explanation
            html += '<div style="margin-bottom: 8px; padding: 6px; background: #dbeafe; border-radius: 4px;">';
            html += '<strong>⚖️ Global Weights:</strong><br>';
            html += '<span style="font-size: 11px; color: #6b7280;">Technical: 28 • Experience: 18 • Job Functions: 15 • Industry: 10 • Certifications: 7 • Education: 7 • Soft Skills: 5</span>';
            html += '</div>';

            // Variables breakdown
            if (result.variables && result.variables.length > 0) {
                html += '<div><strong>📊 Variable Details:</strong></div>';
                html += '<div style="margin-top: 8px;">';
                
                result.variables.forEach(variable => {
                    html += `<div style="margin-bottom: 8px; padding: 6px; background: #f9fafb; border-radius: 4px;">`;
                    html += `<strong>${variable.name}:</strong> <span style="color: #059669; font-weight: bold;">${variable.variable_score || 0} points</span><br>`;
                    
                    if (variable.details && variable.details.length > 0) {
                        variable.details.forEach(detail => {
                            const scoreColor = detail.match_score >= 0.8 ? '#059669' : 
                                             detail.match_score >= 0.6 ? '#10b981' : 
                                             detail.match_score >= 0.4 ? '#f59e0b' : '#dc2626';
                            
                            html += `<div style="margin-top: 4px; padding: 4px; background: white; border-radius: 3px; font-size: 11px;">`;
                            html += `<span style="color: #6b7280;">JD:</span> ${detail.jd_text || 'N/A'}<br>`;
                            html += `<span style="color: #6b7280;">Resume:</span> ${detail.resume_evidence || 'No evidence found'}<br>`;
                            html += `<span style="color: #6b7280;">Criticality:</span> ${detail.criticality || 'N/A'} • `;
                            html += `<span style="color: ${scoreColor}; font-weight: bold;">Score:</span> ${(detail.match_score || 0).toFixed(2)}`;
                            if (detail.offsets) {
                                html += ` • <span style="color: #6b7280;">Offsets:</span> ${detail.offsets}`;
                            }
                            html += '</div>';
                        });
                    }
                    html += '</div>';
                });
                html += '</div>';
            }

            // Fallback indicator
            if (result.fallback) {
                html += '<div style="margin-top: 8px; padding: 6px; background: #fef3c7; border-radius: 4px; color: #92400e;">';
                html += '⚠️ Fallback mode was used due to processing errors in the full system';
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        function formatExtension2Matrix(result) {
            if (!result || !result.matrix) {
                return '<div>No matrix data available</div>';
            }

            let html = '<div><strong>🔍 Extension 2.0 Weighted Analysis:</strong></div>';
            html += '<div style="margin-top: 8px;">';
            
            // Overall summary
            html += `<div style="margin-bottom: 8px; padding: 6px; background: #e5e7eb; border-radius: 4px;">`;
            html += `<strong>Final Score:</strong> ${result.overallScore || 0}% (${result.matchGrade})<br>`;
            html += `<strong>Weighted Score:</strong> ${result.weightedScore || 0}/${result.maxPossibleScore || 0}<br>`;
            html += `<strong>Matrix Items:</strong> ${result.matrix ? result.matrix.length : 0}`;
            if (result.hasCriticalDisqualification) {
                html += '<br><strong style="color: #dc2626;">🚫 Critical Disqualification</strong>';
            }
            html += '</div>';

            // Category weights explanation
            html += '<div style="margin-bottom: 8px; padding: 6px; background: #dbeafe; border-radius: 4px;">';
            html += '<strong>⚖️ Category Weights:</strong><br>';
            html += '<span style="font-size: 11px; color: #6b7280;">Core: 4x • Important: 2.5x • Soft Skill: 1.5x • Preferred: 1x</span><br>';
            html += '<span style="font-size: 11px; color: #6b7280;">Match Levels: Full: 10pts • Partial: 5pts • None: 0pts</span>';
            html += '</div>';

            // Matrix breakdown
            if (result.matrix && result.matrix.length > 0) {
                html += '<div><strong>📊 Matrix Details:</strong></div>';
                html += '<div style="margin-top: 8px;">';
                
                result.matrix.forEach(item => {
                    const categoryWeight = item.categoryType === 'Core' ? 4 : 
                                         item.categoryType === 'Important' ? 2.5 : 
                                         item.categoryType === 'Soft Skill' ? 1.5 : 1;
                    
                    const matchPoints = item.matchLevel === 'full' ? 10 : 
                                      item.matchLevel === 'partial' ? 5 : 0;
                    
                    const totalPoints = matchPoints * categoryWeight;
                    const maxPoints = 10 * categoryWeight;
                    
                    // Color coding for match level
                    const matchColor = item.matchLevel === 'full' ? '#059669' : 
                                     item.matchLevel === 'partial' ? '#f59e0b' : '#dc2626';
                    
                    // Color coding for category type
                    const categoryColor = item.categoryType === 'Core' ? '#dc2626' : 
                                        item.categoryType === 'Important' ? '#f59e0b' : 
                                        item.categoryType === 'Soft Skill' ? '#10b981' : '#6b7280';
                    
                    html += `<div style="margin-bottom: 8px; padding: 6px; background: #f9fafb; border-radius: 4px;">`;
                    html += `<strong>${item.category}:</strong> ${item.requirement}<br>`;
                    html += `<span style="color: #6b7280;">Evidence:</span> ${item.evidence || 'N/A'}<br>`;
                    html += `<span style="color: ${categoryColor}; font-weight: bold;">Category:</span> ${item.categoryType} (${categoryWeight}x weight) • `;
                    html += `<span style="color: ${matchColor}; font-weight: bold;">Match:</span> ${item.matchLevel} (${matchPoints}pts) • `;
                    html += `<span style="color: #059669; font-weight: bold;">Score:</span> ${totalPoints}/${maxPoints}`;
                    
                    if (item.gapAction) {
                        html += `<br><span style="color: #6b7280;">Gap Action:</span> ${item.gapAction}`;
                    }
                    
                    html += '</div>';
                });
                html += '</div>';
            }

            // Strengths, gaps, and recommendations
            if (result.strengths && result.strengths.length > 0) {
                html += '<div style="margin-top: 8px; padding: 6px; background: #d1fae5; border-radius: 4px;">';
                html += '<strong>💪 Strengths:</strong><br>';
                result.strengths.forEach(strength => {
                    html += `• ${strength}<br>`;
                });
                html += '</div>';
            }

            if (result.gaps && result.gaps.length > 0) {
                html += '<div style="margin-top: 8px; padding: 6px; background: #fee2e2; border-radius: 4px;">';
                html += '<strong>❌ Gaps:</strong><br>';
                result.gaps.forEach(gap => {
                    html += `• ${gap}<br>`;
                });
                html += '</div>';
            }

            if (result.recommendations && result.recommendations.length > 0) {
                html += '<div style="margin-top: 8px; padding: 6px; background: #fef3c7; border-radius: 4px;">';
                html += '<strong>💡 Recommendations:</strong><br>';
                result.recommendations.forEach(rec => {
                    html += `• ${rec}<br>`;
                });
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        // Toggle functions for matrix display
        function toggleExtensionMatrix(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = element.style.display === 'none' ? 'block' : 'none';
            }
        }

        function toggleWebAppMatrix(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = element.style.display === 'none' ? 'block' : 'none';
            }
        }

        function toggleExtension2Matrix(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = element.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Make toggle functions globally accessible
        window.toggleExtensionMatrix = toggleExtensionMatrix;
        window.toggleWebAppMatrix = toggleWebAppMatrix;
        window.toggleExtension2Matrix = toggleExtension2Matrix;

        // Export functionality
        function showExportMenu() {
            if (!comparisonResults || !comparisonResults.results || comparisonResults.results.length === 0) {
                alert('No results to export. Please run a comparison first.');
                return;
            }

            const menu = document.createElement('div');
            menu.id = 'export-menu';
            menu.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 1000;
                min-width: 300px;
            `;

            menu.innerHTML = `
                <h3 style="margin-bottom: 16px;">📊 Export Results</h3>
                <div style="margin-bottom: 16px;">
                    <button onclick="exportToCSV('summary')" style="margin: 4px; padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        📈 Export Summary CSV
                    </button>
                    <button onclick="exportToCSV('detailed')" style="margin: 4px; padding: 8px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        📊 Export Detailed CSV
                    </button>
                    <button onclick="exportToCSV('matrix')" style="margin: 4px; padding: 8px 12px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        🔍 Export Matrix Analysis CSV
                    </button>
                    <button onclick="exportToJSON()" style="margin: 4px; padding: 8px 12px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        📋 Export JSON
                    </button>
                </div>
                <div style="margin-top: 16px;">
                    <button onclick="closeExportMenu()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ✕ Close
                    </button>
                </div>
            `;

            // Add overlay
            const overlay = document.createElement('div');
            overlay.id = 'export-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            `;

            document.body.appendChild(overlay);
            document.body.appendChild(menu);
        }

        function closeExportMenu() {
            const menu = document.getElementById('export-menu');
            const overlay = document.getElementById('export-overlay');
            if (menu) menu.remove();
            if (overlay) overlay.remove();
        }

        function exportToCSV(type) {
            const results = comparisonResults.results;
            let csvContent = '';
            let filename = '';

            if (type === 'summary') {
                csvContent = generateSummaryCSV(results);
                filename = 'resume-matching-summary.csv';
            } else if (type === 'detailed') {
                csvContent = generateDetailedCSV(results);
                filename = 'resume-matching-detailed.csv';
            } else if (type === 'matrix') {
                csvContent = generateMatrixCSV(results);
                filename = 'resume-matching-matrix.csv';
            }

            downloadCSV(csvContent, filename);
            closeExportMenu();
        }

        function generateSummaryCSV(results) {
            const headers = [
                'Resume Name',
                'Job Title',
                'Company',
                'Extension 1.0 Score',
                'Extension 1.0 Grade',
                'Extension 1.0 Processing Time (ms)',
                'Extension 2.0 Score', 
                'Extension 2.0 Grade',
                'Extension 2.0 Status',
                'Extension 2.0 Processing Time (ms)',
                'Score Difference',
                'Grade Comparison',
                'Timestamp'
            ];

            let csv = headers.join(',') + '\n';

            results.forEach(result => {
                                const scoreDiff = (result.extensionResult.overallScore || 0) - (result.extension2Result.overallScore || 0);
                const gradeComparison = result.extensionResult.matchGrade === result.extension2Result.matchGrade ? 'Same' :
                    `Ext1: ${result.extensionResult.matchGrade}, Ext2: ${result.extension2Result.matchGrade}`;

                const row = [
                    `"${result.resume.name}"`,
                    `"${result.job.title}"`,
                    `"${result.job.company}"`,
                    result.extensionResult.overallScore || 0,
                    result.extensionResult.matchGrade || 'N/A',
                    result.extensionResult.processingTime || 0,
                    result.extension2Result.overallScore || 0,
                    result.extension2Result.matchGrade || 'N/A',
                    result.extension2Result.hasCriticalDisqualification ? 'Disqualified' : 'Pass',
                    result.extension2Result.processingTime || 0,
                    scoreDiff.toFixed(1),
                    `"${gradeComparison}"`,
                    `"${result.timestamp}"`
                ];

                csv += row.join(',') + '\n';
            });

            return csv;
        }

        function generateDetailedCSV(results) {
            const headers = [
                'Resume Name',
                'Job Title',
                'Company',
                'Extension Score',
                'Extension Strengths Count',
                'Extension Gaps Count',
                'Extension Strengths',
                'Extension Gaps',
                'Extension Recommendations',
                'Web App Score',
                'Web App Variables Count',
                'Web App Technical Score',
                'Web App Experience Score',
                'Web App Job Functions Score',
                'Web App Industry Score',
                'Web App Certifications Score',
                'Web App Education Score',
                'Web App Soft Skills Score',
                'Web App Fallback Used',
                'Processing Time Difference (ms)',
                'Timestamp'
            ];

            let csv = headers.join(',') + '\n';

            results.forEach(result => {
                const extResult = result.extensionResult;
                const webResult = result.webAppResult;
                
                // Calculate variable scores for Web App
                const variableScores = {
                    technical: 0,
                    experience: 0,
                    jobFunctions: 0,
                    industry: 0,
                    certifications: 0,
                    education: 0,
                    softSkills: 0
                };

                if (webResult.variables) {
                    webResult.variables.forEach(variable => {
                        const score = variable.variable_score || 0;
                        const name = variable.name.toLowerCase();
                        if (name.includes('technical')) variableScores.technical = score;
                        else if (name.includes('experience')) variableScores.experience = score;
                        else if (name.includes('job') || name.includes('function')) variableScores.jobFunctions = score;
                        else if (name.includes('industry')) variableScores.industry = score;
                        else if (name.includes('certification')) variableScores.certifications = score;
                        else if (name.includes('education')) variableScores.education = score;
                        else if (name.includes('soft')) variableScores.softSkills = score;
                    });
                }

                const processingTimeDiff = (extResult.processingTime || 0) - (webResult.processingTime || 0);

                const row = [
                    `"${result.resume.name}"`,
                    `"${result.job.title}"`,
                    `"${result.job.company}"`,
                    extResult.overallScore || 0,
                    extResult.strengths ? extResult.strengths.length : 0,
                    extResult.gaps ? extResult.gaps.length : 0,
                    `"${extResult.strengths ? extResult.strengths.join('; ') : 'N/A'}"`,
                    `"${extResult.gaps ? extResult.gaps.join('; ') : 'N/A'}"`,
                    `"${extResult.recommendations ? extResult.recommendations.join('; ') : 'N/A'}"`,
                    webResult.overall_weighted_score || 0,
                    webResult.variables ? webResult.variables.length : 0,
                    variableScores.technical,
                    variableScores.experience,
                    variableScores.jobFunctions,
                    variableScores.industry,
                    variableScores.certifications,
                    variableScores.education,
                    variableScores.softSkills,
                    webResult.fallback ? 'Yes' : 'No',
                    processingTimeDiff,
                    `"${result.timestamp}"`
                ];

                csv += row.join(',') + '\n';
            });

            return csv;
        }

        function generateMatrixCSV(results) {
            const headers = [
                'Resume Name',
                'Job Title',
                'Company',
                'System',
                'Category',
                'Requirement',
                'Evidence',
                'Match Level',
                'Category Type',
                'Points/Max Points',
                'Gap Action',
                'Analysis Type'
            ];

            let csv = headers.join(',') + '\n';

            results.forEach(result => {
                // Extension matrix data
                if (result.extensionResult.matrix) {
                    result.extensionResult.matrix.forEach(item => {
                        const row = [
                            `"${result.resume.name}"`,
                            `"${result.job.title}"`,
                            `"${result.job.company}"`,
                            'Extension',
                            `"${item.category || 'N/A'}"`,
                            `"${item.requirement || 'N/A'}"`,
                            `"${item.evidence || 'N/A'}"`,
                            `"${item.matchLevel || 'N/A'}"`,
                            `"${item.gapAction || 'N/A'}"`,
                            'N/A',
                            'N/A',
                            'Matrix Analysis'
                        ];
                        csv += row.join(',') + '\n';
                    });
                }

                // Extension 2.0 matrix data
                if (result.extension2Result.matrix) {
                    result.extension2Result.matrix.forEach(item => {
                        const categoryWeight = item.categoryType === 'Core' ? 4 : 
                                             item.categoryType === 'Important' ? 2.5 : 
                                             item.categoryType === 'Soft Skill' ? 1.5 : 1;
                        const matchPoints = item.matchLevel === 'full' ? 10 : 
                                          item.matchLevel === 'partial' ? 5 : 0;
                        const totalPoints = matchPoints * categoryWeight;
                        const maxPoints = 10 * categoryWeight;
                        
                        const row = [
                            `"${result.resume.name}"`,
                            `"${result.job.title}"`,
                            `"${result.job.company}"`,
                            'Extension 2.0',
                            `"${item.category || 'N/A'}"`,
                            `"${item.requirement || 'N/A'}"`,
                            `"${item.evidence || 'N/A'}"`,
                            `"${item.matchLevel || 'N/A'}"`,
                            `"${item.categoryType || 'N/A'}"`,
                            `${totalPoints}/${maxPoints}`,
                            `"${item.gapAction || 'N/A'}"`,
                            'Matrix Analysis'
                        ];
                        csv += row.join(',') + '\n';
                    });
                }
            });

            return csv;
        }

        function exportToJSON() {
            const jsonData = {
                metadata: {
                    export_timestamp: new Date().toISOString(),
                    total_results: comparisonResults.results.length,
                    resumes_tested: uploadedResumes.length,
                    jobs_tested: addedJobs.length
                },
                results: comparisonResults.results
            };

            const jsonString = JSON.stringify(jsonData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'resume-matching-results.json';
            a.click();
            
            URL.revokeObjectURL(url);
            closeExportMenu();
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // Make export functions globally accessible
        window.showExportMenu = showExportMenu;
        window.closeExportMenu = closeExportMenu;
        window.exportToCSV = exportToCSV;
        window.exportToJSON = exportToJSON;

        // Update button states
        function updateRunButton() {
            const runBtn = document.getElementById('run-comparison-btn');
            const exportBtn = document.getElementById('export-results-btn');
            const apiKey = document.getElementById('openai-api-key').value.trim();
            
            const canRun = uploadedResumes.length > 0 && addedJobs.length > 0 && !isProcessing && apiKey;
            const hasResults = comparisonResults && Object.keys(comparisonResults).length > 0;
            
            runBtn.disabled = !canRun;
            exportBtn.disabled = !hasResults;
            
            console.log('🔧 Button states updated:', { canRun, hasResults, isProcessing });
        }

        // Initialize the application
        function init() {
            console.log('🔧 Initializing application...');
            
            setupResumeUpload();
            setupJobHandling();
            
            // Load default job descriptions
            console.log('📋 Loading default job descriptions...');
            addedJobs = [...defaultJobs];
            renderJobs();
            
            // Load sample resumes automatically
            console.log('📋 Loading sample attorney resumes...');
            loadSampleResumes();
            
            // Load sample resumes button
            document.getElementById('load-sample-resumes-btn').addEventListener('click', () => {
                console.log('📋 Sample resumes button clicked');
                loadSampleResumes();
            });
            
            // API key input
            document.getElementById('openai-api-key').addEventListener('input', () => {
                console.log('🔑 API key updated');
                updateRunButton();
                updateDebugInfo();
            });
            
            // Run comparison button
            document.getElementById('run-comparison-btn').addEventListener('click', () => {
                console.log('🚀 Run comparison button clicked');
                runComparison();
            });

            // Show comparison matrix button
            document.getElementById('show-comparison-matrix').addEventListener('click', () => {
                console.log('📊 Show comparison matrix button clicked');
                const matrix = document.getElementById('comparison-matrix');
                const button = document.getElementById('show-comparison-matrix');
                if (matrix.style.display === 'none') {
                    matrix.style.display = 'block';
                    button.textContent = '📊 Hide Algorithm Comparison Matrix';
                } else {
                    matrix.style.display = 'none';
                    button.textContent = '📊 Show Algorithm Comparison Matrix';
                }
            });
            
            // Export results button
            document.getElementById('export-results-btn').addEventListener('click', () => {
                console.log('📊 Export button clicked');
                showExportMenu();
            });
            
            // Enhanced matching toggle
            const enhancedToggle = document.getElementById('enhanced-toggle');
            const enhancedCheckbox = document.getElementById('use-enhanced-matching');
            
            enhancedToggle.addEventListener('change', function() {
                console.log('🧪 Enhanced toggle changed:', this.checked);
                enhancedCheckbox.checked = this.checked;
            });
            
            enhancedCheckbox.addEventListener('change', function() {
                console.log('🧪 Enhanced checkbox changed:', this.checked);
                enhancedToggle.checked = this.checked;
            });
            
            updateRunButton();
            updateDebugInfo();
            
            // Update debug info every 2 seconds
            setInterval(updateDebugInfo, 2000);
            
            console.log('✅ Application initialized successfully!');
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html> 